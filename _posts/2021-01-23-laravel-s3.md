---
layout: post
title:  "Utilizzare AWS S3 con Laravel"
author: mattia
categories: [ Laravel, S3, AWS]
image: assets/images/s3_logo.png
rating: 4
---

In questo articolo andremo ad utilizzare Amazon S3 per lo storage in cloud degli asset, fornendo un accesso granulare. Amazon S3 è un servizio di 
cloud computing che offre storage di oggetti scalabile, senza limiti di quantità e con una durevolezza del dato garantita al 99,999999999%.
Questo servizio cloud riesce quindi a semplificare la gestione dello storage di grandi quantità di dati in modo scalabile e ad un costo 
ridotto rispetto a qualsiasi altra soluzione di storage tradizionale, peraltro, a costi parecchio contenuti, dato che i prezzi si aggirano intorno ai 7 centesimi per GB di storage.

## Preparazione del progetto

In un qualunque ambiente Laravel, creiamo una view con un form che permetta di caricare una immagine, in questo caso sto utilizzando materalize ccs come framework per la grafica.

```
<form class = "col s12" method="POST" action="{{ route('image.store') }}" enctype="multipart/form-data">
 @csrf
   <div class = "row">
       <label>Materialize File Input</label>
           <div class = "file-field input-field">
                  <div class = "btn">
                     <span>Browse</span>
                     <input type = "file" name="image" id="image"/>
                  </div>
                  <div class = "file-path-wrapper">
                     <input class = "file-path validate" type = "text"
                        placeholder = "Upload file" />
                  </div>
           </div>
     <input type="submit" value="Submit">
    </div>
 </form>
 ```
 
 Creiamo un Controller e nominiamolo ImageController:
 
 ```
 <?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

class ImageController extends Controller
{
    public function store(Request $request)
    {
        $path = $request->file("image")->store("images");
        return $path;
    }
}
```

Se tutto funziona correttamente, laravel dovrebbe restituirci il path relativo della immagine che abbiamo caricato. Possiamo verificare che la foto ora si trova nella cartella storage/images. Siamo riusciti a caricare una foto in locale, ma il nostro obiettivo era farlo su Amazon S3, vediamo ora come fare.


## Configurazione del bucket S3

Creiamo su AWS un bucket S3. Per farlo sarà sufficiente utilizzare la console del servizio e cliccare sul tasto "crea bucket", assegnamo un nome e lasciamo le impostazioni di default. Successivamente creiamo uno user IAM con diritti di accesso al bucket per poter sfruttare le API di AWS dall'interno del nostro ambiente Laravel. Creiamo un nuovo utente con accesso programmatico, e assegnamogli tutti i diritti su S3 "AmazonS3FullAccess" dalle policy disponibili. Copiamo la chiave di accesso e l'id del nostro User, successivamente modifichiamo il file .env:
```

AWS_ACCESS_KEY_ID=chiave_accesso_IAM
AWS_SECRET_ACCESS_KEY=secret_key_IAM
AWS_DEFAULT_REGION=regione_bucket_s3 (accessibile dalla schermata proprietà del bucket).
AWS_BUCKET=nome_bucket
```

Successivamente come ultimo passo, modifichiamo lo storage nel nostro metodo:

```
 <?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

class ImageController extends Controller
{
    public function store(Request $request)
    {
        $path = $request->file("image")->store("images", "s3");
        return $path;
    }
}
```

e installiamo un pacchetto necessario:

```
./sail composer require league/flysystem-aws-s3-v3 ~1.0
```

potremo osservare che le immagini ora vengono caricate su S3, il nostro controller restituisce il path dell'immagine. Esploriamo ancora alcune possibilità, ora.
Anzitutto, supponiamo di voler utilizzare le immagini caricate come immagini profilo del nostro user. Vogliamo salvare la nostra immagine con un nome umanamente interpretabile e salvare il link a database. Creiamo un nuovo campo a database sullo User.

```
./sail artisan make:migration add_profile_pic_url_field_to_users_table --table=users
```

```
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class AddProfilePicUrlFieldToUsersTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->string('profilePicUrl')->nullable();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn('profilePicUrl');
        });
    }
}
```

Una volta eseguita la migrazione avremo il campo, ora modifichiamo il controller per il caricamento delle immagini.
